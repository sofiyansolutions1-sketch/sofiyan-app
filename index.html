<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sofiyan Home Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons (Spinner, Check, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Poppins', sans-serif;
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      /* Specific class for smaller areas like Time Slot container */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      #location-modal {
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.6);
      }
      
      /* Featured Services Auto-Scroll Animation */
      @keyframes scroll {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); } /* Scrolls half the width (original content) */
      }
      .animate-scroll {
          animation: scroll 80s linear infinite;
          width: max-content;
      }
      .animate-scroll:hover {
          animation-play-state: paused; /* Pauses when user hovers to book */
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "lucide-react": "https://esm.sh/lucide-react@^0.564.0",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.13.0",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@^2.95.3",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.4"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Location Selection Modal -->
    <div id="location-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-visible transform transition-all scale-100">
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-center rounded-t-2xl">
          <div class="bg-white/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
          </div>
          <h2 class="text-2xl font-bold text-white mb-1">Choose your Location</h2>
          <p class="text-indigo-100 text-sm">Search or use GPS for better service</p>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-6">
          <!-- Manual Search with Live Suggestions -->
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Search Location</label>
            <div class="flex gap-2">
              <div class="relative w-full">
                <input type="text" id="manual-location-input" placeholder="Enter city, area or pincode" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50 text-gray-800">
                <!-- Dropdown Container -->
                <ul id="location-suggestions" class="absolute z-50 w-full bg-white border border-gray-200 shadow-xl rounded-b-xl max-h-48 overflow-y-auto hidden mt-1"></ul>
              </div>
              <button id="manual-location-btn" class="bg-indigo-600 text-white px-4 rounded-xl hover:bg-indigo-700 transition-colors flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-4.3-4.3"/><circle cx="11" cy="11" r="8"/></svg>
              </button>
            </div>
          </div>

          <!-- Divider -->
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink-0 mx-4 text-gray-400 text-xs font-semibold uppercase">OR</span>
            <div class="flex-grow border-t border-gray-200"></div>
          </div>

          <!-- GPS Button -->
          <button id="gps-location-btn" class="w-full flex items-center justify-center gap-3 bg-indigo-50 text-indigo-700 p-4 rounded-xl hover:bg-indigo-100 transition-all border border-indigo-100 group">
            <i class="fas fa-location-crosshairs text-lg"></i>
            <span class="font-semibold">Get Current Location (Using GPS)</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const modal = document.getElementById('location-modal');
        const manualInput = document.getElementById('manual-location-input');
        const manualBtn = document.getElementById('manual-location-btn');
        const gpsBtn = document.getElementById('gps-location-btn');
        const suggestionsList = document.getElementById('location-suggestions');

        // Mock Database for Sub-Locations
        const availableLocations = [
           "Connaught Place, New Delhi", "Saket, New Delhi", "Dwarka, New Delhi", "Laxmi Nagar, New Delhi", "Rohini, New Delhi",
           "Andheri East, Mumbai", "Bandra West, Mumbai", "Borivali, Mumbai", "Juhu, Mumbai", "Dadar, Mumbai",
           "Koramangala, Bengaluru", "Indiranagar, Bengaluru", "Whitefield, Bengaluru", "HSR Layout, Bengaluru",
           "Sector 62, Noida", "Sector 18, Noida", "Greater Noida",
           "Gomti Nagar, Lucknow", "Hazratganj, Lucknow", "Alambagh, Lucknow",
           "Hinjewadi, Pune", "Viman Nagar, Pune", "Kothrud, Pune",
           "Salt Lake, Kolkata", "Park Street, Kolkata", "New Town, Kolkata",
           "Banjara Hills, Hyderabad", "Gachibowli, Hyderabad", "Jubilee Hills, Hyderabad"
        ];

        function checkLocationAuth() {
          const savedLocation = localStorage.getItem('savedCustomerLocation');
          if (!savedLocation) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
          }
        }

        function saveAndClose(address) {
          if (!address) return;
          localStorage.setItem('savedCustomerLocation', address);
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }

        // Initialize
        window.onload = checkLocationAuth;

        // 1. Manual Entry Logic (Button Click)
        manualBtn.addEventListener('click', () => {
          const val = manualInput.value.trim();
          if (val) {
            saveAndClose(val);
          } else {
            manualInput.focus();
            manualInput.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => manualInput.classList.remove('ring-2', 'ring-red-500'), 1000);
          }
        });

        // 2. Live Search Logic
        manualInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            suggestionsList.innerHTML = ''; // Clear previous suggestions
            
            if (query.length === 0) {
                suggestionsList.classList.add('hidden');
                return;
            }

            // Filter locations
            const matches = availableLocations.filter(loc => loc.toLowerCase().includes(query));
            
            if (matches.length > 0) {
                suggestionsList.classList.remove('hidden');
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.textContent = match;
                    li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer text-gray-700 border-b last:border-0 text-sm transition-colors";
                    // 3. Selection Logic
                    li.onclick = () => {
                        manualInput.value = match;
                        saveAndClose(match);
                        suggestionsList.classList.add('hidden');
                    };
                    suggestionsList.appendChild(li);
                });
            } else {
                suggestionsList.classList.add('hidden');
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!manualInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.classList.add('hidden');
            }
        });

        // 4. Real GPS Entry Logic with Reverse Geocoding
        gpsBtn.addEventListener('click', () => {
             // Change button text to show loading state
             const originalText = gpsBtn.innerHTML;
             gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Fetching location...';
             gpsBtn.classList.add('opacity-75', 'cursor-wait');
             
             if (navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(
                     // Success Callback
                     async (position) => {
                         const lat = position.coords.latitude;
                         const lon = position.coords.longitude;
                         
                         try {
                             // Free Reverse Geocoding API (OpenStreetMap Nominatim)
                             const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                             if (!response.ok) throw new Error('Geocoding service unavailable');
                             
                             const data = await response.json();
                             
                             // Extract the most relevant address part
                             let realAddress = '';
                             
                             // Strategy: Suburb/Locality + City
                             if (data.address) {
                               const suburb = data.address.suburb || data.address.neighbourhood || data.address.residential || '';
                               const city = data.address.city || data.address.town || data.address.village || data.address.state_district || '';
                               
                               if (suburb && city) {
                                 realAddress = `${suburb}, ${city}`;
                               } else if (city) {
                                 realAddress = city;
                               } else if (data.display_name) {
                                 realAddress = data.display_name.split(',').slice(0, 2).join(',');
                               } else {
                                 realAddress = "Current Location";
                               }
                             } else {
                               realAddress = "Current Location";
                             }
                             
                             // Save to localStorage and Input
                             localStorage.setItem('savedCustomerLocation', realAddress);
                             manualInput.value = realAddress;
                             
                             // Success Feedback
                             gpsBtn.innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i> Location Saved!';
                             gpsBtn.classList.remove('bg-indigo-50', 'text-indigo-700');
                             gpsBtn.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
                             
                             setTimeout(() => {
                                 saveAndClose(realAddress);
                                 // Reset button state slightly delayed for effect
                                 setTimeout(() => {
                                   gpsBtn.innerHTML = originalText;
                                   gpsBtn.classList.remove('bg-green-50', 'text-green-700', 'border', 'border-green-200', 'opacity-75', 'cursor-wait');
                                   gpsBtn.classList.add('bg-indigo-50', 'text-indigo-700');
                                 }, 500);
                             }, 1000);
                             
                         } catch (error) {
                             console.error(error);
                             alert("Failed to fetch address details. Please type your address manually.");
                             gpsBtn.innerHTML = originalText;
                             gpsBtn.classList.remove('opacity-75', 'cursor-wait');
                         }
                     },
                     // Error Callback
                     (error) => {
                         console.error(error);
                         if (error.code === error.PERMISSION_DENIED) {
                             alert("Location access denied! Please allow location permissions in your browser or type your address manually.");
                         } else {
                             alert("Unable to fetch location. Please check your connection or type it manually.");
                         }
                         gpsBtn.innerHTML = originalText;
                         gpsBtn.classList.remove('opacity-75', 'cursor-wait');
                     }
                 );
             } else {
                 alert("Geolocation is not supported by your browser.");
                 gpsBtn.innerHTML = originalText;
                 gpsBtn.classList.remove('opacity-75', 'cursor-wait');
             }
        });
      })();
    </script>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>